<!doctype html>
<html>

<head>
  <meta name="generator" content="JSDoc 3.4.3">
  <meta charset="utf-8">
  <title>Home</title>
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Karla:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Noto+Serif:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Inconsolata:500" type="text/css">
  <link href="css/baseline.css" rel="stylesheet">
</head>

<body onload="prettyPrint()">
  <nav id="jsdoc-navbar" role="navigation" class="jsdoc-navbar">
    <div id="jsdoc-navbar-container">
      <div id="jsdoc-navbar-content">
        <a href="index.html" class="jsdoc-navbar-package-name">Home</a>
      </div>
    </div>
  </nav>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <article>
            <h1>Thorn</h1>
            <p>Thorn is composed of a set of helper abstractions built to ease the process of setting up a SugarCRM's REST API testing environment and interacting with it.</p>
            <h2>Prerequisites</h2>
            <p>You should be familiar with <a href="https://mochajs.org/">mocha</a> and <a href="https://developers.google.com/web/fundamentals/getting-started/primers/promises">JavaScript Promises</a>.</p>
            <h2>Setup</h2><pre class="prettyprint source lang-javascript"><code>const { Agent, Fixtures } = require('@sugarcrm/thorn');</code></pre>
            <h2>Thorn.Fixtures</h2>
            <p><code>Thorn.Fixtures</code> is an object that handles the setup and cleanup process for test sets. It provides methods for creating records, record-relationships, and deleting records in the database.</p>
            <h3>Methods</h3>
            <h4><strong><code>Fixtures.create(models, options)</code> =&gt; <code>{Promise}</code></strong></h4>
            <p>Method to create records in the database.</p>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th style="text-align:left">Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>models</code></td>
                  <td style="text-align:left">{Object&#124;Object[]}</td>
                  <td style="text-align:left">Object or object array that specifies the records to be created. See <a href="#model-structure">Model Structure</a> for details.</td>
                </tr>
                <tr>
                  <td><code>options</code></td>
                  <td style="text-align:left">{Object}</td>
                  <td style="text-align:left">Optional, <code>options.module</code> is the default <code>module</code> for objects in <code>models</code> that do not specify one.</td>
                </tr>
              </tbody>
            </table>
            <p><strong>Returns:</strong></p>
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{Promise}</td>
                  <td style="text-align:left">A <code>Promise</code> which resolves to a map of module names to records created by this method call.</td>
                </tr>
              </tbody>
            </table>
            <p>
              <br/>
            </p>
            <p><strong>Example:</strong></p>
            <pre class="prettyprint source lang-javascript"><code>let AccountsContacts = [
    {
        module: 'Accounts',
        attributes: {
            name: 'MyAccount'
        }
    },
    {
        module: 'Contacts',
        attributes: {
            first_name: 'FirstName'
        }
    }
];

let DashboardsOnly = [
    {
        attributes: {
            name: 'MyDashboard'
        }
    }
];

let response = yield Fixtures.create(AccountsContacts);
console.log(response); // Map containing one account, and one contact
/*
{
    Accounts: [
        {
            id: '12257c7c-bb40-11e6-afb2-a0937b020fc9',
            name: 'MyAccount',
            ...
            _module: 'Accounts'
        }
    ],
    Contacts: [
        {
            id: '11232c7c-bb40-11e6-bfb2-a0937b020sc9',
            first_name: 'FirstName'
            ...
            _module: 'Contacts'
        }
    ]
}
*/

response = yield Fixtures.create(DashboardsOnly, {module: 'Dashboard'});
console.log(response);
/*
{
    Dashboards: [
        {
            id: '11232c7c-bb40-11e6-bfb2-a0937b020sc9',
            name: 'MyDashboard',
            ...
            _module: 'Dashboards'
        }
    ]
}
*/</code></pre>
            <p>
              <br/>
            </p>
            <h4><strong><code>Fixtures.link(left, linkName, right)</code> =&gt; <code>{Promise}</code></strong></h4>
            <p>Method to link records in the database.</p>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th style="text-align:left">Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>left</code></td>
                  <td style="text-align:left">{Object}</td>
                  <td style="text-align:left">A record from the resolution of <code>Fixtures.create</code>.</td>
                </tr>
                <tr>
                  <td><code>linkName</code></td>
                  <td style="text-align:left">{string}</td>
                  <td style="text-align:left">Relationship's link name.</td>
                </tr>
                <tr>
                  <td><code>right</code></td>
                  <td style="text-align:left">{Object}</td>
                  <td style="text-align:left">A record from the resolution of <code>Fixtures.create</code>.</td>
                </tr>
              </tbody>
            </table>
            <p><strong>Returns:</strong></p>
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{Promise}</td>
                  <td style="text-align:left">A <code>Promise</code> which resolves to the body of the server response.</td>
                </tr>
              </tbody>
            </table>
            <p>
              <br/>
            </p>
            <p><strong>Example:</strong></p>
            <pre class="prettyprint source lang-javascript"><code>let Account = {
    module: 'Accounts',
    attributes: {
        name: 'LinkedAccount'
    }
};

let Contact = {
    module: 'Contacts',
    attributes: {
        last_name: 'LinkedContact'
    }
};

let cachedRecords = yield Fixtures.create([Account, Contact]);
console.log(cachedRecords); // Map containing one Account and one Contact

let response = yield Fixtures.link(cachedRecords.Accounts[0], 'accounts_contacts', cachedRecords.Contacts[0]);
// Server response containing the Accounts record and a `related_records` property,
// which contains the Contacts record.
console.log(response);
/*
{
    record: {
        id: '12257c7c-bb40-11e6-afb2-a0937b020fc9',
        name: 'LinkedAccount',
        ...
        _module: 'Accounts'
    },
    related_records: [
        {
            id: '12557c7c-bd40-11e6-afb2-a0345b020fc9',
            last_name: 'LinkedContact',
            ...
            _module: 'Contacts'
        }
    ]
}
*/</code></pre>
            <p>
              <br/>
            </p>
            <h4><strong><code>Fixtures.cleanup()</code> =&gt; <code>{Promise}</code></strong></h4>
            <p>Method to delete all records previously created through <code>Fixtures.create</code>. After cleanup, <code>Fixtures.lookup</code> will throw an error unless more records are created with <code>Fixtures.create</code>.</p>
            <p><strong>Returns:</strong></p>
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{Promise}</td>
                  <td style="text-align:left">A <code>Promise</code> which resolves to the server response to the delete request(s).</td>
                </tr>
              </tbody>
            </table>
            <p>
              <br/>
            </p>
            <h4><strong><code>Fixtures.lookup(module, properties)</code> =&gt; <code>{Object}</code></strong></h4>
            <p>Method that looks through the created records and retrieves the first record that matches module and the key-value pairs in properties.</p>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th style="text-align:left">Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>module</code></td>
                  <td style="text-align:left">{string}</td>
                  <td style="text-align:left">Module name of the record.</td>
                </tr>
                <tr>
                  <td><code>properties</code></td>
                  <td style="text-align:left">{Object}</td>
                  <td style="text-align:left">Object of key-value pairs the record should contain.</td>
                </tr>
              </tbody>
            </table>
            <p><strong>Returns:</strong></p>
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{Object}</td>
                  <td style="text-align:left">A single record object.</td>
                </tr>
              </tbody>
            </table>
            <p>
              <br/>
            </p>
            <h3>Model Structure</h3>
            <p>Models is an object or array of objects that specifies the records the tester intends to create.
              <strong>Properties of each model object:</strong></p>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th style="text-align:left">Type</th>
                  <th style="text-align:left">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>module</code></td>
                  <td style="text-align:left">{string}</td>
                  <td style="text-align:left">Optional, module name of the record.</td>
                </tr>
                <tr>
                  <td><code>attributes</code></td>
                  <td style="text-align:left">{Object}</td>
                  <td style="text-align:left">Specific fields the record should have. Unspecified required field values are auto-generated.</td>
                </tr>
              </tbody>
            </table>
            <p>
              <br/>
            </p>
            <h3>Tips</h3>
            <ul>
              <li>
                <p><code>Fixtures</code> is designed to be a tool that facilitates the setup and cleanup of test cases. Its methods are <em>not</em> meant to provide a means of testing the correctness of SugarCRM's record creation, linking, and deletion
                  APIs. Such tests should make use of the request methods of <code>UserAgent</code>.</p>
              </li>
              <li>
                <p>The same model object cannot be used to create multiple records; this will lead to collisions in <code>Fixtures</code> internal ways of storing records. To reuse the same model to create multiple records, all but the first model must be
                  cloned ( e.g. using <code>_.clone</code>).</p>
              </li>
              <li>
                <p>Linking records requires that the records have already been created in the database. To avoid exceptions, structure the record creations such that dependencies are met before <code>Fixtures</code> tries to make links.</p>
              </li>
            </ul>
            <h2>Thorn.Agent</h2>
            <p>Thorn provides an Agent class that simulates a REST API user agent. You should use this class for all of your Thorn tests except those which test the Users API directly (in which case you should use the <a href="chakram">chakram API</a> directly).</p>
            <h3>Creating Agents</h3>
            <p>An Agent corresponds directly to a user that exists in the SugarCRM instance you are testing. All users except for the admin user specified by the <code>THORN_ADMIN_USERNAME</code> environment variable <em>must</em> be created by <code>Fixtures.create</code>              before you attempt to create a user agent for it. Please refer to <a href="#thorn::fixtures">Thorn Fixtures API</a> to create the needed users.</p>
            <p>User agents are created with <code>Agent.as</code>:</p>
            <pre class="prettyprint source lang-javascript"><code>// assuming a user called &quot;Dashboards.John&quot; already exists
let john = Agent.as('Dashboards.John');</code></pre>
            <p><strong>This also logs the user in if they have not been logged in already.</strong></p>
            <h3>Making requests</h3>
            <p>Agents can make HTTP GET, POST, PUT, and DELETE requests against any SugarCRM REST API endpoint. Each request method has a corresponding function, which makes the desired request and returns a JavaScript Promise which resolves to a <a href="https://dareid.github.io/chakram/jsdoc/global.html#ChakramResponse">Chakram response object</a>              corresponding to the server's response to the request:</p>
            <pre class="prettyprint source lang-javascript"><code>let response = yield john.get('Accounts');
console.log('%j', response.response.body);
// displays response body</code></pre>
            <p>Required user refreshes are handled automatically by an agent. If a request fails with HTTP status 401, the agent's authentication is refreshed and the request is automatically retried. However, each request is only retried once to prevent
              infinite loops.</p>
            <h3>Request Methods</h3>
            <h4>get</h4><pre class="prettyprint source lang-javascript"><code>let response = yield john.get('Accounts');
console.log(response.response.body);
/*
{
    next_offset: -1,
    records: [
        {
            id: '12257c7c-bb40-11e6-afb2-a0999b020fc9',
            name: 'Accounts.Samantha',
            date_entered: '2016-12-05T15:10:53-08:00',
            date_modified: '2016-12-05T15:10:53-08:00',
            ...
            _module: 'Accounts'
        },
        ...
    ]
*/</code></pre>
            <h4>post</h4><pre class="prettyprint source lang-javascript"><code>let response = yield john.post('Accounts', { name: 'Accounts.Smith' });
console.log(response.response.body);
/*
{
    id: '10e42218-bb41-11e6-82c7-a0999b020fc9',
    name: 'Accounts.Smith',
    date_entered: '2016-12-05T15:18:00-08:00',
    date_modified: '2016-12-05T15:18:00-08:00',
    ...
}
*/</code></pre>
            <h4>put</h4><pre class="prettyprint source lang-javascript"><code>// assuming &quot;id&quot; is the the ID of Accounts.Smith
let response = yield john.put('Accounts/' + id, { industry: 'Not For Profit' });
console.log(response.response.body);
/*
{
    id: '10e42218-bb41-11e6-82c7-a0999b020fc9',
    name: 'Accounts.Smith',
    date_entered: '2016-12-05T15:54:26-08:00',
    date_modified: '2016-12-05T15:54:27-08:00',
    industry: 'Not For Profit',
    ...
}
*/</code></pre>
            <h4>delete</h4><pre class="prettyprint source lang-javascript"><code>let response = yield john.delete('Accounts' + id);
console.log(response.response.body);
/*
{ id: '10e42218-bb41-11e6-82c7-a0999b020fc9' }
*/</code></pre>
            <h3>Request Arguments</h3>
            <p>All request methods accept an endpoint and HTTP request parameters; <code>Agent.put</code>, <code>Agent.post</code>, and <code>Agent.delete</code> additionally accept a request body.</p>
            <h5>Endpoints</h5>
            <p>Endpoints are specified relative to <code>/rest/&lt;version&gt;/</code> (see <a href="#api-versioning">API versioning</a>), so example endpoints might be <code>'Accounts'</code>, <code>'Contacts/&lt;contactId&gt;'</code>, or <code>'Forecasts/&lt;timePeriodId&gt;/progressRep/&lt;userId&gt;'</code>.</p>
            <h5>Request Bodies</h5>
            <p>Request bodies must be JSON-serializable JavaScript objects. They are passed directly to the SugarCRM server.</p>
            <h5>Parameters</h5>
            <p>See <a href="https://github.com/request/request#requestoptions-callback">the parameter documentation</a> for details of possible parameters.</p>
            <p>It is <em>NOT</em> necessary to explicitly include OAuth tokens or other authentication details in your requests; this is handled transparently by Thorn. <strong>Attempting to do so may interfere with Thorn's proper operation.</strong></p>
            <h4>API versioning</h4>
            <p>Agents make requests against the default API version (currently, <code>v10</code>) by default. To make requests against a different API version, use <code>Agent.on</code>:</p>
            <pre class="prettyprint source lang-javascript"><code>let johnV11 = john.on('v11');

// all requests made against API version 11
let response = yield johnV11.get('Dashboards');
...

let response = yield johnV11.get('KBContents');
...</code></pre>
            <p>Note that the original Agent remains valid and can continue to make requests against the default API version with no additional effort:</p>
            <pre class="prettyprint source lang-javascript"><code>let response = yield john.get('Notifications')
...</code></pre>
            <h2>Best Practices</h2>
            <ul>
              <li>
                <p>Every test file should be wrapped in a <code>describe</code> block to protect against cross-test contamination.</p>
              </li>
              <li>
                <p>In the <code>before</code> and <code>after</code> functions, as well as in <code>Promise</code> chains, every <code>Promise</code> created must be <code>returned</code> in order for server requests to effectuate. Not returning <code>Promises</code>                  could lead to test failures and false positives.</p>
              </li>
            </ul>
            <h2>Debugging Tests</h2>
            <p>While developing or debugging a test, you can set the environment variable <code>THORN_VERBOSE</code> to enable verbose output from Thorn.</p>
            <p>Users of Thorn seeking to debug their tests should set <code>THORN_VERBOSE=1</code>.
              <code>THORN_VERBOSE=2</code> is intended for those developing Thorn itself and is not intended for users.</p>
            <p>Before commiting tests, <strong>please ensure you run them with THORN_VERBOSE=1</strong> so you can be sure you are making the HTTP requests and getting the responses back that you expect.</p>
          </article>
          <div class="symbol-index">
            <section>
              <div class="symbol-index-content">
                <h2 id="thorn">thorn</h2>
                <div class="symbol-index-section">
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn.html" class="!symbol-index-name">thorn</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                    </dl>
                  </div>
                </div>
              </div>
            </section>
            <section>
              <div class="symbol-index-content">
                <h2 id="thorn~Agent">thorn~Agent</h2>
                <div class="symbol-index-section">
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-Agent.html" class="!symbol-index-name">thorn~<wbr>Agent</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-Agent.html#.as" class="!symbol-index-name">thorn~<wbr>Agent.<wbr>as(username)</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                    </dl>
                  </div>
                </div>
              </div>
            </section>
            <section>
              <div class="symbol-index-content">
                <h2 id="thorn~Fixtures">thorn~Fixtures</h2>
                <div class="symbol-index-section">
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-Fixtures.html" class="!symbol-index-name">thorn~<wbr>Fixtures</a>
            </dt>
                      <dd>
                      </dd>
                      <dt class="symbol-index-name">
                <a href="module-thorn-Fixtures.html#.cleanup" class="!symbol-index-name">thorn~<wbr>Fixtures.<wbr>cleanup()</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-Fixtures.html#.create" class="!symbol-index-name">thorn~<wbr>Fixtures.<wbr>create(models[, options])</a>
            </dt>
                      <dd>
                      </dd>
                      <dt class="symbol-index-name">
                <a href="module-thorn-Fixtures.html#.link" class="!symbol-index-name">thorn~<wbr>Fixtures.<wbr>link(left, linkName, right)</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-Fixtures.html#.lookup" class="!symbol-index-name">thorn~<wbr>Fixtures.<wbr>lookup(module, properties)</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </section>
            <section>
              <div class="symbol-index-content">
                <h2 id="thorn~UserAgent">thorn~UserAgent</h2>
                <div class="symbol-index-section">
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-UserAgent.html" class="!symbol-index-name">thorn~<wbr>UserAgent(username, password, version)</a>
            </dt>
                      <dd>
                      </dd>
                      <dt class="symbol-index-name">
                <a href="module-thorn-UserAgent.html#delete" class="!symbol-index-name">thorn~<wbr>UserAgent#<wbr>delete(endpoint[, data][, params])</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-UserAgent.html#get" class="!symbol-index-name">thorn~<wbr>UserAgent#<wbr>get(endpoint[, params])</a>
            </dt>
                      <dd>
                      </dd>
                      <dt class="symbol-index-name">
                <a href="module-thorn-UserAgent.html#on" class="!symbol-index-name">thorn~<wbr>UserAgent#<wbr>on(version)</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                  <div class="symbol-index-column">
                    <dl class="symbol-index-list">
                      <dt class="symbol-index-name">
                <a href="module-thorn-UserAgent.html#post" class="!symbol-index-name">thorn~<wbr>UserAgent#<wbr>post(endpoint, data[, params])</a>
            </dt>
                      <dd>
                      </dd>
                      <dt class="symbol-index-name">
                <a href="module-thorn-UserAgent.html#put" class="!symbol-index-name">thorn~<wbr>UserAgent#<wbr>put(endpoint, data[, params])</a>
            </dt>
                      <dd>
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
  <script src="scripts/jquery.min.js"></script>
  <script src="scripts/jquery.cookie.js"></script>
  <script src="scripts/tree.jquery.js"></script>
  <script src="scripts/prettify.js"></script>
  <script src="scripts/jsdoc-toc.js"></script>
  <script src="scripts/linenumber.js"></script>
  <script src="scripts/scrollanchor.js"></script>
</body>

</html>